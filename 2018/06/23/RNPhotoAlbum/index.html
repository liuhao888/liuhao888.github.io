<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description"><meta name="keywords" content="Hexo, Gruntjs, Nodejs, Reactjs, Vuejs"><title>RN 枚举相册 - Ted</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.ico" type="image/x-icon"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com"><span>Github</span></a></li><li><a href="https://www.v2ex.com/"><span>V2EX</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="/images/post_background.jpg"><div class="post-title"><h1 class="title">RN 枚举相册</h1><ul class="meta"><li><i class="icon icon-author"></i>Ted.H.Liu</li><li><i class="icon icon-clock"></i>19 Minutes</li><li><i class="icon icon-calendar"></i>June 23, 2018</li></ul></div></div><div class="article-content" style="max-width:800px"><h2 id="RN-枚举相册"><a href="#RN-枚举相册" class="headerlink" title="RN 枚举相册"></a>RN 枚举相册</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>项目中遇到一个需求：“用户在上传图片时，展示用户相册图片选择或者相机拍摄”，由于以前没有接触过这个方面，也遇到了很多问题，在此记录一下。</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>搜索引擎搜索问题时我看到 <code>react-native-image-crop-picker</code> 和 <code>React Native Image Picker</code> 这两个库都支持选取和拍照、处理图片（前者比后者多了一个剪切功能）。但是实现方式是调用API进入系统相册进入选取，与需求中直接展示用户所有图片不符。后来发现 React—Native 官方有一个读取本地相册的API: <code>CameraRoll</code>;</p>
<h3 id="CameraRoll-配置"><a href="#CameraRoll-配置" class="headerlink" title="CameraRoll 配置"></a>CameraRoll 配置</h3><p>关于该方法RN中文网没有说的很清楚，详细可以看<a href="http://facebook.github.io/react-native/docs/cameraroll.html" target="_blank" rel="noopener">这里</a> 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">CameraRoll.getPhotos(params)</span><br><span class="line">params :</span><br><span class="line"> - first ：&#123;number&#125;：照片应用程序的逆序排列顺序的照片数量（即SavedPhotos最近的第一张照片）。</span><br><span class="line"> - after：&#123;string&#125;：与page_info &#123; end_cursor &#125;之前调用返回的匹配的游标getPhotos。</span><br><span class="line"> - groupTypes：&#123;string&#125;：指定要将结果过滤到的组类型。有效值是：</span><br><span class="line">		* Album</span><br><span class="line">		* All</span><br><span class="line">		* Event</span><br><span class="line">		* Faces</span><br><span class="line">		* Library</span><br><span class="line">		* PhotoStream</span><br><span class="line">		* SavedPhotos //默认</span><br><span class="line">- groupName ：&#123;string&#125;：指定群组名称上的过滤器，如“最近的照片”或自定义相册标题。</span><br><span class="line">	* </span><br><span class="line">- assetType：&#123;字符串&#125;：指定资产类型的过滤器。有效值是：</span><br><span class="line">		* All</span><br><span class="line">		* Videos</span><br><span class="line">		* Photos //默认</span><br><span class="line">- mimeTypes ：&#123;string&#125;：按mimetype过滤（例如image / jpeg）。</span><br><span class="line">&gt; 返回一个Promise，它在解析时将具有以下形状：</span><br><span class="line"></span><br><span class="line">- edges ：&#123;Array &lt;node&gt;&#125;节点对象数组</span><br><span class="line">	* node：&#123;object&#125;具有以下形状的对象：</span><br><span class="line">				* type：&#123;string&#125;</span><br><span class="line">				* group_name：&#123;string&#125;</span><br><span class="line">	* image：&#123;object&#125;：具有以下形状的对象：</span><br><span class="line">					* uri：&#123;string&#125;</span><br><span class="line">					* height：&#123;number&#125;</span><br><span class="line">					* width：&#123;number&#125;</span><br><span class="line">					* isStored：&#123;布尔&#125;</span><br><span class="line">- page_info ：&#123;object&#125;：具有以下形状的对象：</span><br><span class="line">		* has_next_page：&#123;布尔&#125;</span><br><span class="line">		* start_cursor：&#123;布尔&#125;</span><br><span class="line">		* end_cursor：&#123;布尔&#125;</span><br></pre></td></tr></table></figure>
<p>在IOS上首先要LInk RCTCameraRoll 库，把 <code>node_module/react-native/Libraries/CameraRoll/RCTCameraRoll.xcodeproj</code> 添加到 <code>project name =&gt; Liberaries</code> ,  然后在 <code>Build Phases -&gt; Link Binary With Libraries</code> 里添加 <code>libRCTCameraRoll.a</code>,如下图：<br><img src="/images/page/RNPhotoAlbum/xcode.png" alt="Alt text"></p>
<p>以及在 <code>Info.plist</code> 添加获取照片相机权限及描述<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;key&gt;NSCameraUsageDescription&lt;/key&gt;</span><br><span class="line">&lt;string&gt;XXX需要获取相机权限，以提供更好的服务&lt;/string&gt;</span><br><span class="line">&lt;key&gt;NSPhotoLibraryUsageDescription&lt;/key&gt;</span><br><span class="line">&lt;string&gt;XXX需要获取相册权限，以提供更好的服务&lt;/string&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>经过一系列的配置我们终于进入代码部分了，列表我采用0.41后推出的<code>FlatList</code> 优化渲染，不多废话直接看Dome代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">componentDidMount() &#123;</span><br><span class="line">  this.setState(&#123; isLoading: true &#125;, () =&gt; &#123;</span><br><span class="line">    // 根据参数获取本地照片</span><br><span class="line">    // default &#123;</span><br><span class="line">    //   first: 1000,</span><br><span class="line">    //   groupTypes: &quot;SavedPhotos&quot;,</span><br><span class="line">    //   assetType: &quot;Photos&quot;</span><br><span class="line">    // &#125;</span><br><span class="line">    CameraRoll.getPhotos(this.props.photosParams)</span><br><span class="line">      .then(data =&gt; &#123;</span><br><span class="line">        this.setState(&#123;</span><br><span class="line">          isLoading: false,</span><br><span class="line">          photosData: data.edges,</span><br><span class="line">          pageInfo: data.page_info</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch(e =&gt; &#123;</span><br><span class="line">        this.setState(&#123; isLoading: false &#125;);</span><br><span class="line">        console.log(e);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">render() &#123;</span><br><span class="line">  const &#123; photosData &#125; = this.state;</span><br><span class="line">  return (</span><br><span class="line">    &lt;View style=&#123;styles.flex&#125;&gt;</span><br><span class="line">      &lt;FlatList</span><br><span class="line">        data=&#123;photosData || []&#125;</span><br><span class="line">        renderItem=&#123;this.renderItem&#125;</span><br><span class="line">        numColumns=&#123;rowNumber&#125;</span><br><span class="line">        refreshing=&#123;this.state.isLoading&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;/View&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到在 componentDidMount 中调用 <code>CameraRoll.getPhotos</code> 读取用户相册，处理后续 Promise 交由 FlatList 优化渲染（处理下拉加载更多或者上拉刷新等操作）。</p>
<p>现在只是把相册读取出来，我们还需要显示一个相机模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if(index === 0)&#123;</span><br><span class="line">      return this.renderCameraItem();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果图如下：<br><img src="/images/page/RNPhotoAlbum/photoAlbum.png" alt="Alt text"></p>
<p>dome部分完整代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">export default class Example extends Component &#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    super(props);</span><br><span class="line"></span><br><span class="line">    //计算图片尺寸</span><br><span class="line">    const &#123; width &#125; = Dimensions.get(&quot;window&quot;);</span><br><span class="line">    const itemSize = (width - (rowNumber + 1) * imageMargin) / rowNumber;</span><br><span class="line"></span><br><span class="line">    this.state = &#123;</span><br><span class="line">      itemSize,</span><br><span class="line">      photosData: [],</span><br><span class="line">      pageInfo: &#123;&#125;,</span><br><span class="line">      isLoading: false</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    this.renderItem = this.renderItem.bind(this);</span><br><span class="line">    this.renderCameraItem = this.renderCameraItem.bind(this);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    this.setState(&#123; isLoading: true &#125;, () =&gt; &#123;</span><br><span class="line">      // 根据参数获取本地照片</span><br><span class="line">      // default &#123;</span><br><span class="line">      //   first: 1000,</span><br><span class="line">      //   groupTypes: &quot;SavedPhotos&quot;,</span><br><span class="line">      //   assetType: &quot;Photos&quot;</span><br><span class="line">      // &#125;</span><br><span class="line">      CameraRoll.getPhotos(this.props.photosParams)</span><br><span class="line">        .then(data =&gt; &#123;</span><br><span class="line">          const photosData = [&#123;&#125;,...data.edges];</span><br><span class="line">          this.setState(&#123;</span><br><span class="line">            isLoading: false,</span><br><span class="line">            photosData: photosData,</span><br><span class="line">            pageInfo: data.page_info</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(e =&gt; &#123;</span><br><span class="line">          this.setState(&#123; isLoading: false &#125;);</span><br><span class="line">          console.log(e);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  renderCameraItem() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;View</span><br><span class="line">        style=&#123;[</span><br><span class="line">          styles.itemCamera,</span><br><span class="line">          &#123;</span><br><span class="line">            height: this.state.itemSize,</span><br><span class="line">            width: this.state.itemSize,</span><br><span class="line">            marginLeft: imageMargin,</span><br><span class="line">            marginBottom: imageMargin</span><br><span class="line">          &#125;</span><br><span class="line">        ]&#125;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;Text&gt;相机拍照&lt;/Text&gt;</span><br><span class="line">      &lt;/View&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  renderItem(&#123; item, index &#125;) &#123;</span><br><span class="line">    if(index === 0)&#123;</span><br><span class="line">      return this.renderCameraItem();</span><br><span class="line">    &#125;</span><br><span class="line">    return (</span><br><span class="line">      &lt;Image</span><br><span class="line">        source=&#123;&#123; uri: item.node.image.uri &#125;&#125;</span><br><span class="line">        style=&#123;&#123;</span><br><span class="line">          width: this.state.itemSize,</span><br><span class="line">          height: this.state.itemSize,</span><br><span class="line">          marginLeft: imageMargin,</span><br><span class="line">          marginBottom: imageMargin</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    const &#123; photosData &#125; = this.state;</span><br><span class="line">    return (</span><br><span class="line">      &lt;View style=&#123;styles.flex&#125;&gt;</span><br><span class="line">        &lt;FlatList</span><br><span class="line">          data=&#123;photosData || []&#125;</span><br><span class="line">          renderItem=&#123;this.renderItem&#125;</span><br><span class="line">          numColumns=&#123;rowNumber&#125;</span><br><span class="line">          refreshing=&#123;this.state.isLoading&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      &lt;/View&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="后续优化"><a href="#后续优化" class="headerlink" title="后续优化"></a>后续优化</h3><ol>
<li>实际场景中用户可能会存在有几千张照片，这种一次性读取的做法显然不可靠，所以我们可以使用<code>after</code> 属性。</li>
<li>目前代码中照片的尺寸是判断设备的宽度计算的，可能不是最优做法，而且在手机横屏状态下会变形。</li>
</ol>
</div><div class="article-meta" style="max-width:800px"><div class="categories"><i class="icon icon-category"></i><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/学习记录/">学习记录</a><span class="category-list-count">1</span></li></ul></div></div><div class="article-comment" style="max-width:800px"><div class="ds-thread" id="ds-thread" data-thread-key="cjiqzyz0z0000vkkidp3quqsq" data-title="RN 枚举相册" data-url="http://yoursite.com/2018/06/23/RNPhotoAlbum/" site-name="ueibo"></div><script>var siteName = document.getElementById('ds-thread').getAttribute('site-name');
var duoshuoQuery = {short_name: siteName};
</script></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://weibo.com/" title="Weibo" target="_blank"><i class="icon icon-weibo"></i></a></li><li><a href="https://www.segmentfault.com/" title="SegmentFault" target="_blank"><i class="icon icon-segmentfault"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2018 Ted<br><small>POWER BY <a href="https://hexo.io" target="_blank">HEXO</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>